<tool id="ip_2d_feature_extraction" name="Extract image features" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.05">
    <description>with scikit-image</description>
    <macros>
        <import>creators.xml</import>
        <token name="@TOOL_VERSION@">0.25.2</token>
        <token name="@VERSION_SUFFIX@">0</token>
        <xml name="features">
            <param name="features" type="select" label="Available features" multiple="true" display="checkboxes">
                <option value="label">Label from the label map</option>
                <yield/>
                <option value="area">Area</option>
                <option value="area_convex">Convex area</option>
                <option value="bbox">Bounding box</option>
                <option value="centroid">Centroid</option>
                <option value="moments">Moments</option>
                <option value="moments_hu">Moments Hu</option>
                <option value="area_filled">Filled area</option>
                <option value="perimeter">Perimeter</option>
                <option value="extent">Extent</option>
                <option value="eccentricity">Eccentricity</option>
                <option value="equivalent_diameter_area">Equivalent diameter</option>
                <option value="euler_number">Euler number</option>
                <option value="inertia_tensor_eigvals">Inertia tensor eigenvalues</option>
                <option value="axis_major_length">Major axis length</option>
                <option value="axis_minor_length">Minor axis length</option>
                <option value="orientation">Orientation</option>
                <option value="solidity">Solidity</option>
                <option value="convexity">Convexity</option>
            </param>
        </xml>
    </macros>
    <creator>
        <expand macro="creators/bmcv"/>
        <expand macro="creators/kostrykin"/>
    </creator>
    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">scikit-image</xref>
        <xref type="bio.tools">giatools</xref>
        <xref type="bio.tools">galaxy_image_analysis</xref>
        <xref type="biii">scikit-image</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">scikit-image</requirement>
        <requirement type="package" version="2.2.2">pandas</requirement>
        <requirement type="package" version="0.7.1">giatools</requirement>
    </requirements>
    <required_files>
        <include type="literal" path="2d_feature_extraction.py"/>
    </required_files>
    <command detect_errors="aggressive"><![CDATA[

        python '$__tool_directory__/2d_feature_extraction.py'

        #if $labels.extension == "zarr"
            --labels '$labels.extra_files_path/$labels.metadata.store_root'
        #else
            --labels '$labels'
        #end if

        #if $setup.mode == "with-intensities"
            #if $setup.intensities.extension == "zarr"
                --intensities '$setup.intensities.extra_files_path/$setup.intensities.metadata.store_root'
            #else
                --intensities '$setup.intensities'
            #end if
        #end if

        --output '$output'
        --params '$params'
        --verbose

    ]]></command>
    <configfiles>
        <configfile name="params"><![CDATA[
            {
                "features": [
                    ${ ', '.join('"%s"' % t.strip() for t in str( $setup['features'] ).split(',')) }
                ]
            }
        ]]></configfile>
    </configfiles>
    <inputs>
        <param name="labels" type="data" format="tiff,zarr,png" label="Label map"/>
        <conditional name="setup">
            <param label="Use the intensity image to compute additional features" name="mode" type="select">
                <option value="without-intensities" selected="true">No intensity image</option>
                <option value="with-intensities">Use intensity image</option>
            </param>
            <when value="without-intensities">
                <expand macro="features"/>
            </when>
            <when value="with-intensities">
                <param name="intensities" type="data" format="tiff,zarr,png,jpg" label="Intensity image"/>
                <expand macro="features">
                    <option value="max_intensity">Max Intensity (requires original image)</option>
                    <option value="mean_intensity">Mean Intensity (requires original image)</option>
                    <option value="min_intensity">Minimum Intensity (requires original image)</option>
                </expand>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="tabular" name="output"/>
    </outputs>
    <tests>
        <!-- Single-channel 2-D -->
        <test>
            <param name="labels" value="input/input12.tiff"/>
            <conditional name="setup">
                <param name="mode" value="without-intensities"/>
                <param name="features" value="label,area,area_convex,convexity"/>
            </conditional>
            <output name="output" ftype="tabular" value="output/input12.tsv"/>
        </test>
        <test>
            <param name="labels" value="input/input11.tiff"/>
            <conditional name="setup">
                <param name="mode" value="with-intensities"/>
                <param name="intensities" value="input/input1_uint8.tiff"/>
                <param name="features" value="area,mean_intensity"/>
            </conditional>
            <output name="output" ftype="tabular" value="output/input11.tsv"/>
        </test>
        <!-- Single-channel 3-D -->
        <test>
            <param name="labels" value="input/input9.zarr"/>
            <conditional name="setup">
                <param name="mode" value="with-intensities"/>
                <param name="intensities" value="input/input8_zyx.zarr"/>
                <param name="features" value="perimeter,area,mean_intensity,convexity"/>
            </conditional>
            <output name="output" ftype="tabular" value="output/input9.tsv"/>
        </test>
        <!-- Multi-channel (forbidden) -->
        <!--
        <test>
            <param name="labels" value="input/input12.tiff"/>
            <conditional name="setup">
                <param name="mode" value="with-intensities"/>
                <param name="intensities" value="input/input3-uint16.tiff"/>
                <param name="features" value="label"/>
            </conditional>
        </test>
        -->
        <!-- TODO: Add test case for multi-channel Zarr -->
    </tests>
    <help>

        **Computes features of a label map.**

        The computed features are computed based solely on the properties of the labels in the label map,
        or, optionally, by also taking the intensities from a corresponding intensity image into account.

        The label map must be a 2-D or 3-D single-channel image.
    
    </help>
    <citations>
        <citation type="doi">10.1016/j.jbiotec.2017.07.019</citation>
    </citations>
</tool>
