<tool id="ip_2d_filter_segmentation_by_features" name="Filter label map by rules" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.05">
    <description>with giatools</description>
    <macros>
        <import>creators.xml</import>
        <import>tests.xml</import>
        <import>validators.xml</import>
        <token name="@TOOL_VERSION@">0.7.1</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <creator>
        <expand macro="creators/bmcv"/>
        <expand macro="creators/kostrykin"/>
    </creator>
    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">galaxy_image_analysis</xref>
        <xref type="bio.tools">giatools</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">giatools</requirement>
        <requirement type="package" version="0.25.2">scikit-image</requirement>
        <requirement type="package" version="2.2.2">pandas</requirement>
    </requirements>
    <required_files>
        <include type="literal" path="2d_filter_segmentation_by_features.py"/>
    </required_files>
    <command detect_errors="aggressive"><![CDATA[

        python '$__tool_directory__/2d_filter_segmentation_by_features.py'

        #if $labels.extension == "zarr"
            --labels '$labels.extra_files_path/$labels.metadata.store_root'
        #else
            --labels '$labels'
        #end if

        --output   'output.tiff'
        --features '$features'
        --rules    '$rules'
        --params   '$params'

        --verbose

    ]]></command>
    <configfiles>
        <configfile name="params"><![CDATA[
            {
            }
        ]]></configfile>
    </configfiles>
    <inputs>
        <param name="labels" type="data" format="tiff,zarr,png" label="Label map">
            <expand macro="validators/is_single_channel"/>
            <expand macro="validators/is_single_frame"/>
        </param>
        <param name="features" type="data" format="tabular" label="Features"/>
        <param name="rules" type="data" format="tabular" label="Rules"/>
    </inputs>
    <outputs>
       <data format="tiff" name="output" from_work_dir="output.tiff"/>
    </outputs>
    <tests>
        <!-- Single-channel 2-D -->
        <test>
            <param name="labels" value="input/input12.png"/>
            <param name="features" value="input/input12-features.tsv"/>
            <param name="rules" value="input/input12-rules.tsv"/>
            <expand macro="tests/label_image_diff" name="output" value="output/input12.tiff" ftype="tiff"/>
        </test>
        <!-- TODO: add test for a label missing in the features file -->
        <!-- Single-channel 3-D -->
        <test>
            <param name="labels" value="input/input9.zarr"/>
            <param name="features" value="input/input9-features.tsv"/>
            <param name="rules" value="input/input9-rules1.tsv"/>
            <expand macro="tests/label_image_diff" name="output" value="output/input9-rules1.tiff" ftype="tiff"/>
        </test>
        <test>
            <param name="labels" value="input/input9.zarr"/>
            <param name="features" value="input/input9-features.tsv"/>
            <param name="rules" value="input/input9-rules2.tsv"/>
            <output name="output" ftype="tiff">
                <assert_contents>
                    <has_image_n_labels n="0" exclude_labels="0"/><!-- all background -->
                </assert_contents>
            </output>
        </test>
        <!-- Multi-channel (forbidden) -->
        <test expect_failure="true">
            <param name="labels" value="input/input3_uint16.tiff"/>
            <param name="features" value="input/input12-features.tsv"/>
            <param name="rules" value="input/input12-rules.tsv"/>
            <assert_stderr>
                <!-- Rejected by validator -->
                <has_n_lines n="0"/>
            </assert_stderr>
            <assert_stdout>
                <!-- Rejected by validator -->
                <has_n_lines n="0"/>
            </assert_stdout>
        </test>
        <test expect_failure="true">
            <param name="labels" value="input/input10.zarr"/>
            <param name="features" value="input/input12-features.tsv"/>
            <param name="rules" value="input/input12-rules.tsv"/>
            <assert_stderr>
                <!-- Rejected by py-script -->
                <has_text text="This tool is not applicable to images with CYX axes."/>
            </assert_stderr>
        </test>
    </tests>
    <help>

        **Filters a label map by rules (e.g., remove large or deformed objects).**

        The properties of the labeled image regions (features) must be provided in a specific tabular format
        (columns: ``label``, ``feature1``, ``feature2``, and so on, where ``feature1`` and ``feature2`` can be arbitrary strings).
        Each row corresponds to a labeled image region.
        An example is given below.

        +-------+-------+---------------------+
        | label | area  | eccentricity        |
        +-------+-------+---------------------+
        | 1     | 344   | 0.42521053699241596 |
        +-------+-------+---------------------+
        | 2     | 434   | 0.47679001553231926 |
        +-------+-------+---------------------+
        | 3     | 907   | 0.9973539531125177  |
        +-------+-------+---------------------+
        | 4     | 14320 | 0.17131009631035327 |
        +-------+-------+---------------------+

        The rules also must be supplied in a specific tabular format with three columns.
        The first row contains the header names of the columns (``features``, ``min``, ``max``).
        Each subsequent row starts with the name of a feature (such as ``feature1`` or ``feature2``, see above),
        followed by the corresponding minimum and maximum allowed values for that feature.
        A labeled image region is retrained in the label map if and only if it passes all checks with repsect to the given ``min`` and ``max`` values.
        An example is given below.

        +--------------+--------+--------------+
        | feature      | min    | max          |
        +--------------+--------+--------------+
        | area         | 500    | 100000       |
        +--------------+--------+--------------+
        | eccentricity | 0.     | 0.5          |
        +--------------+--------+--------------+

    </help>
    <citations>
        <citation type="doi">10.1016/j.jbiotec.2017.07.019</citation>
    </citations>
</tool>
