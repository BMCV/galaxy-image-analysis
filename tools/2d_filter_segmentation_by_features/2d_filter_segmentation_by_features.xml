<tool id="ip_2d_filter_segmentation_by_features" name="Filter label map by rules" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.05">
    <description>with giatools</description>
    <macros>
        <import>creators.xml</import>
        <import>tests.xml</import>
        <import>validators.xml</import>
        <token name="@TOOL_VERSION@">0.7.1</token>
        <token name="@VERSION_SUFFIX@">0</token>
    </macros>
    <creator>
        <expand macro="creators/bmcv"/>
        <expand macro="creators/kostrykin"/>
    </creator>
    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">galaxy_image_analysis</xref>
        <xref type="bio.tools">giatools</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">giatools</requirement>
        <requirement type="package" version="0.25.2">scikit-image</requirement>
        <requirement type="package" version="2.2.2">pandas</requirement>
    </requirements>
    <required_files>
        <include type="literal" path="2d_filter_segmentation_by_features.py"/>
    </required_files>
    <command detect_errors="aggressive"><![CDATA[

        python '$__tool_directory__/2d_filter_segmentation_by_features.py'

        #if $labels.extension == "zarr"
            --labels '$labels.extra_files_path/$labels.metadata.store_root'
        #else
            --labels '$labels'
        #end if

        --output   'output.tiff'
        --features '$features'
        --rules    '$rules'
        --params   '$params'

        --verbose

    ]]></command>
    <configfiles>
        <configfile name="params"><![CDATA[
            {
            }
        ]]></configfile>
    </configfiles>
    <inputs>
        <param name="labels" type="data" format="tiff,zarr,png" label="Label map">
            <expand macro="validators/is_single_channel"/>
            <expand macro="validators/is_single_frame"/>
        </param>
        <param name="features" type="data" format="tabular" label="Features"/>
        <param name="rules" type="data" format="tabular" label="Rules"/>
    </inputs>
    <outputs>
       <data format="tiff" name="output" from_work_dir="output.tiff"/>
    </outputs>
    <tests>
        <test>
            <param name="labels" value="in.tiff"/>
            <param name="features" value="features.tabular"/>
            <param name="rules" value="rules.tabular"/>
            <expand macro="tests/label_image_diff" name="output" value="out.tiff" ftype="tiff"/>
        </test>
    </tests>
    <help>

        **Filters a label map by rules (e.g., remove large or deformed objects).**

        The properties of the labeled image regions (features) must be provided in a specific tabular format
        (columns: ``label``, ``feature1``, ``feature2``, and so on, where ``feature1`` and ``feature2`` can be arbitrary strings).
        Each row corresponds to a labeled image region.
        An example is given below.

        +-------+-------+---------------------+
        | label | area  | eccentricity        |
        +-------+-------+---------------------+
        | 1     | 344   | 0.42521053699241596 |
        +-------+-------+---------------------+
        | 2     | 434   | 0.47679001553231926 |
        +-------+-------+---------------------+
        | 3     | 907   | 0.9973539531125177  |
        +-------+-------+---------------------+
        | 4     | 14320 | 0.17131009631035327 |
        +-------+-------+---------------------+

        The rules also must be supplied in a specific tabular format with three rows.
        The top-left cell is empty, and the rest of the first row corresponds to the feature names (such as ``feature1`` or ``feature2``, see above).
        The rest of the first column corresponds to the two values ``min`` and ``max``.
        Each of the rows defines the minimum and maximum values for the corresponding features.
        A labeled image region is retrained if and only if it passes all checks with repsect to the given ``min`` and ``max`` values.
        An example is given below.

        +-----+--------+--------------+
        |     | area   | eccentricity |
        +-----+--------+--------------+
        | min | 500    | 0.           |
        +-----+--------+--------------+
        | max | 100000 | 0.5          |
        +-----+--------+--------------+

    </help>
    <citations>
        <citation type="doi">10.1016/j.jbiotec.2017.07.019</citation>
    </citations>
</tool>
