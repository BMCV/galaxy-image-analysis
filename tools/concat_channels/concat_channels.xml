<tool id="ip_concat_channels" name="Concatenate images or channels" version="0.4" profile="20.05">
    <description></description>
    <macros>
        <import>creators.xml</import>
        <import>tests.xml</import>
    </macros>
    <creator>
        <expand macro="creators/bmcv"/>
    </creator>
    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">galaxy_image_analysis</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="0.25.2">scikit-image</requirement>
        <requirement type="package" version="2.3.5">numpy</requirement>
        <requirement type="package" version="2025.10.16">tifffile</requirement>
        <requirement type="package" version="0.4.1">giatools</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[

        python '$__tool_directory__/concat_channels.py'

        #for $input in $inputs
            '$input'
        #end for

        '$output'
        '$axis'

        $mode

    ]]></command>
    <inputs>
        <param name="inputs" type="data" multiple="true" format="tiff,png" label="Images to concatenate"/>
        <param name="axis" type="select" label="Concatenation axis" help="The images will be concatenated along this axis.">
            <option value="X">X-axis (concatenate images or image sequences horizontally)</option>
            <option value="Y">Y-axis (concatenate images or image sequences vertically)</option>
            <option value="T">T-axis (concatenate images as frames of a temporal image sequence)</option>
            <option value="Z">Z-axis (concatenate images as slices of a 3-D image or image sequence)</option>
            <option value="C" selected="true">C-axis (concatenate the channels/samples of images or image sequences)</option>
            <option value="Q">Q-axis (concatenate along other or unknown axis)</option>
        </param>
        <param name="mode" type="select" label="Scaling of values" help="If the brightness is to be preserved (default), then the values will be scaled between 0 and 1, and a floating point pixel data type will be used.">
            <option value="" selected="true">Preserve brightness</option>
            <option value="--preserve_values">Preserve range of values</option>
        </param>
    </inputs>
    <outputs>
        <data format="tiff" name="output"/>
    </outputs>
    <tests>
        <!-- Test with "preserve brightness", vertical concatenation -->
        <test>
            <param name="inputs" value="input1_uint8.png,input2_float.tiff"/>
            <param name="axis" value="Y"/>
            <param name="mode" value=""/>
            <expand macro="tests/intensity_image_diff" name="output" value="res_preserve_brightness.tiff" ftype="tiff"/>
        </test>
        <!-- Test with "preserve range of values", vertical concatenation -->
        <test>
            <param name="inputs" value="input1_uint8.png,input2_float.tiff"/>
            <param name="axis" value="Y"/>
            <param name="mode" value="--preserve_values"/>
            <expand macro="tests/intensity_image_diff" name="output" value="res_preserve_values.tiff" ftype="tiff">
                <has_image_mean_intensity min="0" max="255"/>
            </expand>
            <!--
            <output name="output" value="res_preserve_values.tiff" ftype="tiff" compare="image_diff" metric="rms" eps="0.01">
                <assert_contents>
                    <has_image_mean_intensity min="0" max="255"/>
                </assert_contents>
            </output>
            -->
        </test>
        <!-- Test concatenation of channels (axis *exists* in both images) -->
        <test>
            <param name="inputs" value="input1_uint8.png,input2_float.tiff"/>
            <param name="axis" value="C"/>
            <output name="output" ftype="tiff">
                <assert_contents>
                    <has_image_width value="119"/>
                    <has_image_height value="119"/>
                    <has_image_depth value="0"/>
                    <has_image_channels value="8"/>
                    <has_image_frames value="0"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test concatenation of frames (axis *does not* exist in both images) -->
        <test>
            <param name="inputs" value="input1_uint8.png,input2_float.tiff"/>
            <param name="axis" value="T"/>
            <output name="output" ftype="tiff">
                <assert_contents>
                    <has_image_width value="119"/>
                    <has_image_height value="119"/>
                    <has_image_depth value="0"/>
                    <has_image_channels value="4"/>
                    <has_image_frames value="2"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>

        **Concatenates images along arbitrary axes.**

        This can be used, for example, to spatially concatenate images, or along their channels.

        This tool either preserves the image brightness, or the range of values.
        In general, both cannot be preserved when concatenating images of different pixel types (e.g., uint8 and uint16).

    </help>
    <citations>
        <citation type="doi">10.1016/j.jbiotec.2017.07.019</citation>
    </citations>
</tool>
