<tool id="ip_binary_to_labelimage" name="Convert binary image to label map" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@">
    <description>with giatools</description>
    <macros>
        <import>creators.xml</import>
        <token name="@TOOL_VERSION@">0.7.1</token>
        <token name="@VERSION_SUFFIX@">1</token>
        <xml name="input">
            <!-- JPEG is not allowed because it is a lossy compression that has no strictly constant labels -->
            <param name="input" type="data" format="tiff,zarr,png" label="Binary image">
                <!--
                The OME-Zarr datatype in Galaxy is currently not derived from the Image datatype, and it does
                hence not inherit the metadata fields like `num_unique_unique`. To cope with that, we allow all
                datasets except those where we *know* that they are *not* binary.
                -->
                <validator type="expression" message="Dataset is not a binary image"
                    ><![CDATA[getattr(value.metadata, "num_unique_values", None) in (None, '') or int(value.metadata.num_unique_values) <= 2]]></validator>
                <yield/>
            </param>
        </xml>
    </macros>
    <creator>
        <expand macro="creators/bmcv"/>
        <expand macro="creators/kostrykin"/>
    </creator>
    <edam_operations>
        <edam_operation>operation_3443</edam_operation>
    </edam_operations>
    <xrefs>
        <xref type="bio.tools">galaxy_image_analysis</xref>
        <xref type="bio.tools">giatools</xref>
    </xrefs>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">giatools</requirement>
        <requirement type="package" version="1.16.3">scipy</requirement>
        <requirement type="package" version="0.12.2">ome-zarr</requirement>
    </requirements>
    <required_files>
        <include type="literal" path="binary2label.py"/>
    </required_files>
    <command detect_errors="aggressive"><![CDATA[

        python '$__tool_directory__/binary2label.py'

        #if $setup.input.extension == "zarr"
            --input '$setup.input.extra_files_path/$setup.input.metadata.store_root'
        #else
            --input '$setup.input'
        #end if

        --output 'output.tiff'
        --params '$params'

    ]]></command>
    <configfiles>
        <configfile name="params"><![CDATA[
            {

            #if str($setup.method) == "watershed"
                "min_distance": $setup.min_distance,
            #end if

                "method": "$setup.method"

            }
        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="setup">
            <param name="method" type="select" label="Mode"
                   help="Connected component analysis assigns unique labels to object that are separated by 1 pixel or more. Watershed transform can also separate partially overlapping objects, but is only applicable to 2-D image data.">
                <option value="cca" selected="true">Connected component analysis</option>
                <option value="watershed">Watershed transform</option>
            </param>
            <when value="cca">
                <expand macro="input"/>
            </when>
            <when value="watershed">
                <expand macro="input">
                    <!--
                    The OME-Zarr datatype in Galaxy is currently not derived from the Image datatype, and it does
                    hence not inherit the metadata fields like `depth`. To cope with that, we allow all datasets
                    except those where we *know* that they are *not* 2-D.
                    -->
                    <validator type="expression" message="Dataset is a 3-D image"
                        ><![CDATA[getattr(value.metadata, "depth", None) in (None, '') or int(value.metadata.depth) < 2]]></validator>
                </expand>
                <param name="min_distance" type="integer" min="0" value="5" label="Minimum distance between two objects"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="tiff" name="output" from_work_dir="output.tiff"/>
    </outputs>
    <tests>
        <test>
            <conditional name="setup">
                <param name="method" value="cca"/>
                <param name="input" value="galaxyIcon_noText.tiff"/>
            </conditional>
            <output name="output" value="label.tiff" ftype="tiff" compare="image_diff"/>
        </test>
        <test>
            <conditional name="setup">
                <param name="method" value="watershed"/>
                <param name="input" value="in.tiff"/>
                <param name="min_distance" value="10"/>
            </conditional>
            <output name="output" value="out.tiff" ftype="tiff" compare="image_diff"/>
        </test>
        <test>
            <conditional name="setup">
                <param name="method" value="cca"/>
                <param name="input" value="uint8_z12_x11_y10.tiff"/>
            </conditional>
            <output name="output" value="uint8_z12_x11_y10-output.tiff" ftype="tiff" compare="image_diff">
                <assert_contents>
                    <has_image_width width="11"/>
                    <has_image_height height="10"/>
                    <has_image_depth depth="12"/>
                </assert_contents>
            </output>
        </test>
        <!-- Tests for 3-D -->
        <test>
            <conditional name="setup">
                <param name="method" value="cca"/>
                <param name="input" value="input/input9.zarr"/>
            </conditional>
            <output name="output" value="output/input9-cca.tiff" ftype="tiff" compare="image_diff"/><!-- TODO: migrate to macros -->
        </test>
        <test expect_failure="true">
            <conditional name="setup">
                <param name="method" value="watershed"/>
                <param name="input" value="input/input9.zarr"/>
            </conditional>
            <assert_stderr>
                <!-- Rejected by py-script -->
                <has_text text='Method "watershed" is not applicable to 3-D images.'/>
            </assert_stderr>
        </test>
        <test expect_failure="true">
            <conditional name="setup">
                <param name="method" value="watershed"/>
                <param name="input" value="input/input9.tiff"/>
            </conditional>
            <assert_stderr>
                <!-- Rejected by validator -->
                <has_n_lines n="0"/>
            </assert_stderr>
        </test>
        <!-- Tests for multi-channel images -->
        <test expect_failure="true">
            <conditional name="setup">
                <param name="method" value="cca"/>
                <param name="input" value="input/input10.zarr"/>
            </conditional>
            <assert_stderr>
                <!-- Rejected by py-script -->
                <has_text text='Multi-channel images are forbidden to avoid confusion with multi-channel labels (e.g., RGB labels).'/>
            </assert_stderr>
        </test>
        <test expect_failure="true">
            <conditional name="setup">
                <param name="method" value="cca"/>
                <param name="input" value="input/rgb.png"/>
            </conditional>
            <assert_stderr>
                <!-- Rejected by validator -->
                <has_n_lines n="0"/>
            </assert_stderr>
        </test>
    </tests>
    <help>

        **Converts a binary image to a label map.**

        This tool assigns each object a unique label.

        Individual objects are determined using connected component analysis, or distance transform and watershed.

    </help>
    <citations>
        <citation type="doi">10.1016/j.jbiotec.2017.07.019</citation>
    </citations>
</tool>
