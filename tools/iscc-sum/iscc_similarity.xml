<tool id="iscc_sum_similarity" name="Find files with similar ISCC hashes" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.1">
    <description>with ISCC-SUM</description>
    <macros>
        <import>macros.xml</import>
        <import>creators.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <creator>
        <expand macro="creators/iscc" />
        <expand macro="creators/lco" />
        <expand macro="creators/maartenpaul" />
        <expand macro="creators/etzm" />
    </creator>
        
    <command detect_errors="exit_code"><![CDATA[
        ## Create working directory
        mkdir -p input_files &&
        
        ## Symlink files with proper names
        #for $i, $file in enumerate($input_files):
            ln -s '$file' 'input_files/${file.element_identifier}_${i}' &&
        #end for
        
        ## Run similarity detection
        iscc-sum --similar --threshold $threshold input_files/* > similarity_raw.txt &&
        
        ## Parse into tabular format
        python '$__tool_directory__/iscc_similarity_parse_output.py' similarity_raw.txt '$output_file'
    ]]></command>

    <inputs>
        <param name="input_files" type="data" format="data" multiple="true"
               label="Files to compare"
               help="Select multiple files or provide a collection. ISCC-SUM will find similar files."/>
        <param name="threshold" type="integer" value="12" min="0" max="64"
               label="Similarity threshold"
               help="Maximum Hamming distance (0=identical, 12=default, higher=more lenient)"/>
    </inputs>
    
    <outputs>
        <data name="output_file" format="tabular" label="${tool.name} on ${on_string}"/>
    </outputs>
    
    <tests>
        <!-- Test 1: Two identical files (duplicate selection) -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test1.png"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="5"/>
                    <has_n_lines n="2"/>
                    <has_text text="test1.png"/>
                    <has_text text="K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <has_text text="0"/>
                </assert_contents>
            </output>
        </test>
        
        <!-- Test 2: Three files - two identical, one different -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test2.tiff,test2.tiff"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="5"/>
                    <has_text text="test1.png"/>
                    <has_text text="test2.tiff"/>
                    <has_text text="K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <has_text text="K4AGSPOSB5SS2X427WZ27QASTSBVTS55DXLMFDF7WOJKEOSTDEI3OXQ"/>
                    <has_text text="0"/>
                    <has_text text="-1"/>
                </assert_contents>
            </output>
        </test>
        
<!-- Test 3: Multiple files with two identical -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test2.tiff,test2.tiff"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="5"/>
                    <has_text text="test1.png"/>
                    <has_text text="test2.tiff"/>
                    <has_text text="0"/>
                    <has_text text="-1"/>
                </assert_contents>
            </output>
        </test>
        
        <!-- Test 4: No similarities with strict threshold -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test3.fasta"/>
            <param name="threshold" value="5"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="5"/>
                    <has_text text="test1.png"/>
                    <has_text text="test3.fasta"/>
                    <has_text text="-1"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
What it does
============

Finds similar files by comparing their ISCC Data-Code components using Hamming distance.

This tool identifies content similarity even when:

- Files have been modified slightly
- Files are renamed copies
- Files are different versions of the same content

How Similarity Works
====================

ISCC uses the Data-Code component (part of the 55-character hash) to measure content similarity via Hamming distance. Lower numbers mean more similar:

- **0**: Identical content
- **1-5**: Nearly identical
- **6-12**: Likely similar (default threshold)
- **13-20**: Somewhat similar
- **20+**: Different content

Input
=====

Provide multiple files or a collection. The tool compares all files against each other to find similar pairs.

Threshold Parameter
===================

The threshold controls how similar files must be to be reported:

- **Lower threshold** (e.g., 5): Only very similar files
- **Default** (12): Balanced - catches similar content without too many false positives
- **Higher threshold** (e.g., 20): More lenient - includes loosely similar files

Output
======

A tabular file with one row per similarity match::

    filename    iscc_hash    similar_to    distance
    file1.txt   K4AOMG...    file2.txt     8
    file1.txt   K4AOMG...    file3.txt     10
    file4.txt   K4AGSPO...                 -1

Where:

- **filename**: Reference file
- **iscc_hash**: ISCC hash of reference file
- **similar_to**: Matching file (empty if no matches)
- **distance**: Hamming distance (0=identical, -1=no matches)

Files with no similar matches have distance=-1.

Use Cases
=========

Find duplicates in large datasets
----------------------------------

::

    Input: Collection of 1000 research images
    Threshold: 8 (strict)
    ↓
    [Find similar ISCC hashes]
    ↓
    Output: List of near-duplicate pairs
    ↓
    [Filter: distance < 5]
    ↓
    Result: Exact or near-exact duplicates to remove

Detect renamed files
--------------------

::

    Input: Two collections (before/after reorganization)
    ↓
    [Find similar ISCC hashes]
    ↓
    Output: Matches showing which files are the same
    ↓
    Result: Mapping of old names to new names

Track document versions
-----------------------

::

    Input: Collection of report versions
    Threshold: 15 (lenient)
    ↓
    [Find similar ISCC hashes]
    ↓
    Output: Version relationships
    ↓
    [Group by: filename] ← Galaxy tool
    ↓
    Result: Version tree showing document evolution

Working with Results
====================

The tabular output can be filtered and processed with Galaxy tools:

**Find exact duplicates**::

    [Filter: distance == 0]

**Find very similar files**::

    [Filter: distance <= 5]

**Group by reference file**::

    [Group data: filename]
    
**Create similarity network**::

    Import to Cytoscape or graph tools

Important Notes
===============

- **Content-based**: Similarity based on file content, not metadata
- **Format-independent**: Can match files in different formats
- **Not for exact verification**: Use "Verify ISCC hash" for exact checksums
- **Ordering independent**: File order in collection doesn't matter
- **Pairwise comparison**: All files compared against each other

Comparison with Other Tools
============================

+------------------------+------------------+---------------------+
| Tool                   | Use Case         | Output              |
+========================+==================+=====================+
| Generate ISCC          | Create checksums | Individual hashes   |
+------------------------+------------------+---------------------+
| Verify ISCC            | Exact matching   | OK/FAILED           |
+------------------------+------------------+---------------------+
| Find similar (this)    | Content similar  | Distance scores     |
+------------------------+------------------+---------------------+

More Information
================

For details about ISCC: https://sum.iscc.codes/
    ]]></help>
    <expand macro="citations" />
</tool>