<tool id="iscc_sum_similarity" name="Find datasets with similar ISCC-CODEs" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.1">
    <description>with ISCC-SUM</description>
    <macros>
        <import>macros.xml</import>
        <import>creators.xml</import>
    </macros>
    <expand macro="requirements" />
    <required_files>
        <include type="literal" path="iscc_similarity_parse_output.py"/>
    </required_files>
    <expand macro="version_command" />
    <creator>
        <expand macro="creators/iscc" />
        <expand macro="creators/lco" />
        <expand macro="creators/maartenpaul" />
        <expand macro="creators/etzm" />
    </creator>
        
    <command detect_errors="exit_code"><![CDATA[
        ## Create working directory
        mkdir -p input_files &&        
        ## Create mapping file: filename -> element_identifier
        printf "filename\telement_identifier\n" > id_mapping.tsv &&
        ## Symlink files and record their identifiers
        #for $file in $input_files:
            ln -s '$file' 'input_files/${file.id}_${file.element_identifier}' &&
            printf "${file.id}_${file.element_identifier}\t${file.name}\n" >> id_mapping.tsv &&
        #end for
        
        ## Run similarity detection
        iscc-sum --similar --threshold $threshold input_files/* > similarity_raw.txt &&
        
        ## Parse into tabular format with identifiers
        python '$__tool_directory__/iscc_similarity_parse_output.py' similarity_raw.txt id_mapping.tsv '$output_file'

    ]]></command>

    <inputs>
        <param name="input_files" type="data" format="data" multiple="true"
               label="Datasets to compare"
               help="Select multiple datasets or provide a collection. ISCC-SUM will find similar datasets."/>
        <param name="threshold" type="integer" value="12" min="0" max="64"
               label="Similarity threshold"
               help="Maximum Hamming distance (0=identical, 12=default, higher=more lenient)"/>
    </inputs>
    
    <outputs>
        <data name="output_file" format="tabular" label="${tool.name} on ${on_string}"/>
    </outputs>
    
    <tests>
        <!-- Test 1: Two identical datasets (duplicates) -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test1_copy.png"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="7"/>
                    <has_n_lines n="3"/>  <!-- Header + 2 bidirectional rows -->
                    <has_text text="test1.png"/>
                    <has_text text="K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <!-- Check that files are identical (distance=0) and have matches (not -1) -->
                    <has_text text="&#09;0&#10;"/>  <!-- Tab before 0, newline after -->
                    <not_has_text text="&#09;-1&#10;"/>  <!-- No files without matches -->
                </assert_contents>
            </output>
        </test>

        <!-- Test 2: Three datasets - two identical, one different -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test2.tiff,test1_copy.png"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="7"/>
                    <has_n_lines n="4"/>  <!-- Header + 2 bidirectional rows + 1 no-match -->
                    <has_text text="test1.png"/>
                    <has_text text="test2.tiff"/>
                    <has_text text="K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <has_text text="K4AGSPOSB5SS2X427WZ27QASTSBVTS55DXLMFDF7WOJKEOSTDEI3OXQ"/>
                    <!-- Check that we have both identical files (distance=0) and unmatched files (distance=-1) -->
                    <has_text text="&#09;0&#10;"/>  <!-- Identical files -->
                    <has_text text="&#09;-1&#10;"/>  <!-- Unmatched file -->
                </assert_contents>
            </output>
        </test>

        <!-- Test 3: Multiple datasets with none identical -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test1.png,test2.tiff,test3.fasta"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="7"/>
                    <has_n_lines n="4"/>  <!-- Header + 3 no-match rows -->
                    <has_text text="test1.png"/>
                    <has_text text="test2.tiff"/>
                    <has_text text="test3.fasta"/>
                    <!-- Check that all files have no matches (distance=-1) -->
                    <has_text text="&#09;-1&#10;"/>
                    <not_has_text text="&#09;0&#10;"/>  <!-- No identical files -->
                </assert_contents>
            </output>
        </test>

        <!-- Test 4: Two similar image datasets (similar, not identical, in the similar file a few pixels differ) -->
        <test expect_num_outputs="1">
            <param name="input_files" value="test2.tiff,test2_similar.tiff"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="7"/>
                    <has_n_lines n="3"/>  <!-- Header + 2 bidirectional rows -->
                    <has_text text="test2.tiff"/>
                    <has_text text="test2_similar.tiff"/>
                    <has_text text="K4AGSPOSB5SS2X427WZ27QASTSBVTS55DXLMFDF7WOJKEOSTDEI3OXQ&#09;3&#10;"/>
                    <has_text text="K4AGSPOSB5SW2X427WZK7QAQTSBVSNSQLY3ITST6FAP52LY75L6LL5Q&#09;3&#10;"/>
                    <!-- Check that distance is not 0 (not identical) and not -1 (has matches) -->
                    <not_has_text text="&#09;0&#10;"/>  <!-- Not identical -->
                    <not_has_text text="&#09;-1&#10;"/>  <!-- Has matches -->
                </assert_contents>
            </output>
        </test>

        <!-- Test 5: Two similar text datasets (similar, not identical, some characters differ) -->
        <test expect_num_outputs="1">
            <param name="input_files" value="sequence1.txt,sequence2.txt"/>
            <param name="threshold" value="12"/>
            <output name="output_file" ftype="tabular">
                <assert_contents>
                    <has_n_columns n="7"/>
                    <has_n_lines n="3"/>  <!-- Header + 2 bidirectional rows -->
                    <has_text text="sequence1.txt"/>
                    <has_text text="sequence2.txt"/>
                    <has_text text="K4AARSU4SMH3MJAVBYQXBIKHHQNKUZGLNB22HEK5GUAU56QHHYXUXIA&#09;7&#10;"/>
                    <has_text text="K4AIRSE4SMH3NJAVR2QXFIKHHQNLUDXB2E5P3ZZ3RREBKVJL4WTG3QQ&#09;7&#10;"/>
                    <!-- Check that distance is not 0 (not identical) and not -1 (has matches) -->
                    <not_has_text text="&#09;0&#10;"/>  <!-- Not identical -->
                    <not_has_text text="&#09;-1&#10;"/>  <!-- Has matches -->
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
What it does
============

Finds similar datasets by comparing their ISCC-CODE Data-Code components using Hamming distance.

This tool identifies content similarity even when:

- Datasets have been modified slightly
- Datasets are renamed copies
- Datasets are different versions of the same content

How Similarity Works
====================

ISCC-SUM uses the Data-Code component (part of the 55-character ISCC-CODE) to measure content similarity via Hamming distance. Lower numbers mean more similar:

- **0**: Identical content
- **1-5**: Nearly identical
- **6-12**: Likely similar (default threshold)
- **13-20**: Somewhat similar
- **20+**: Different content

Input
=====

Provide multiple datasets or a collection. The tool compares all datasets against each other to find similar pairs.

Threshold Parameter
===================

The threshold controls how similar datasets must be to be reported:

- **Lower threshold** (e.g., 5): Only very similar datasets
- **Default** (12): Balanced - catches similar content without too many false positives
- **Higher threshold** (e.g., 20): More lenient - includes loosely similar datasets

Output
======

A tabular file with one row per similarity relationship (bidirectional)::

    file_id      filename    iscc_code    match_id     match_filename    match_iscc_code    distance
    123  file1.txt   K4AOMG...    124  file2.txt         K4AOMG...          8
    124  file2.txt   K4AOMG...    123  file1.txt         K4AOMG...          8
    123  file1.txt   K4AOMG...    125  file3.txt         K4AOMG...          10
    125  file3.txt   K4AOMG...    123  file1.txt         K4AOMG...          10
    126  file4.txt   K4AGSPO...                                                      -1

Where:

- **file_id**: Unique Galaxy identifier for the reference dataset
- **filename**: Display name of reference dataset
- **iscc_code**: ISCC-CODE of reference dataset
- **match_id**: Unique Galaxy identifier for matching dataset (empty if no matches)
- **match_filename**: Display name of matching dataset (empty if no matches)
- **match_iscc_code**: ISCC-CODE of matching dataset (empty if no matches)
- **distance**: Hamming distance (0=identical, -1=no matches)

**Important Notes:**

- Each similarity match appears **twice** (A→B and B→A) to make filtering easier
- Files with no similar matches have distance=-1 and empty match columns
- Use **file_id** to uniquely identify datasets (handles duplicate filenames)
- Use **filename** for human-readable identification

Use Cases
=========

Find duplicates in large datasets
----------------------------------

::

    Input: Collection of 1000 research images
    Threshold: 8 (strict)
    ↓
    [Find similar ISCC-CODEs]
    ↓
    Output: List of near-duplicate pairs
    ↓
    [Filter: distance < 5]
    ↓
    Result: Exact or near-exact duplicates to remove

Detect renamed files
--------------------

::

    Input: Two collections (before/after reorganization)
    ↓
    [Find similar ISCC-CODEs]
    ↓
    Output: Matches showing which files are the same
    ↓
    Result: Mapping of old names to new names

Track document versions
-----------------------

::

    Input: Collection of report versions
    Threshold: 15 (lenient)
    ↓
    [Find similar ISCC-CODEs]
    ↓
    Output: Version relationships
    ↓
    [Group by: filename] ← Galaxy tool
    ↓
    Result: Version tree showing document evolution

Working with Results
====================

The tabular output can be filtered and processed with Galaxy tools:

**Find exact duplicates**::

    [Filter: distance == 0]

**Find very similar files**::

    [Filter: distance <= 5]

**Group by reference file**::

    [Group data: filename]
    
**Create similarity network**::

    Import to Cytoscape or graph tools

Important Notes
===============

- **Content-based**: Similarity based on file content, not metadata
- **Format-independent**: Can match files in different formats
- **Not for exact verification**: Use "Verify ISCC-CODE" for exact checksums
- **Ordering independent**: File order in collection doesn't matter
- **Pairwise comparison**: All files compared against each other

Comparison with Other ISCC Tools
=================================

+------------------------+------------------+---------------------+
| Tool                   | Use Case         | Output              |
+========================+==================+=====================+
| Generate ISCC-CODE     | Create codes     | Individual codes    |
+------------------------+------------------+---------------------+
| Verify ISCC-CODE       | Exact matching   | OK/FAILED           |
+------------------------+------------------+---------------------+
| Find similar (this)    | Content similar  | Distance scores     |
+------------------------+------------------+---------------------+

More Information
================

For details about ISCC: https://sum.iscc.codes/ and https://iscc.codes/
For ISCC structure and subtypes: https://ieps.iscc.codes/iep-0001/
    ]]></help>
    <expand macro="citations" />
</tool>