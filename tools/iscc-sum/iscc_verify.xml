<tool id="iscc_sum_verify" name="Verify ISCC hash" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.1">
    <description>with ISCC-SUM</description>
    <macros>
        <import>macros.xml</import>
        <import>creators.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <creator>
        <expand macro="creators/iscc" />
        <expand macro="creators/lco" />
        <expand macro="creators/maartenpaul" />
        <expand macro="creators/etzm" />
    </creator>
        
    <command detect_errors="exit_code"><![CDATA[
        ## Generate ISCC for input file
        GENERATED=\$(iscc-sum '${input_file}' | cut -d':' -f2 | cut -d' ' -f1) &&
        
        ## Get expected hash
        EXPECTED='${expected_hash}' &&
        
        ## Validate expected hash length
        if [ \${#EXPECTED} -ne 55 ]; then
            echo "ERROR: Expected ISCC hash must be exactly 55 characters" >&2;
            echo "Found: \${#EXPECTED} characters" >&2;
            exit 1;
        fi &&
        
        ## Output verification report
        if [ "\$GENERATED" = "\$EXPECTED" ]; then
            echo "OK - Hashes match" > '${output_file}'; 
        else
            echo "FAILED - Hashes do not match" > '${output_file}'; 
        fi &&
        echo "Expected:  \$EXPECTED" >> '${output_file}' &&
        echo "Generated: \$GENERATED" >> '${output_file}' &&
        echo "" >> '${output_file}' 
    
    ]]></command>

    <inputs>
        <param name="input_file" type="data" format="data" label="File to verify"
               help="Verify this file's ISCC hash. When a collection is provided, each file is verified separately against the same expected hash."/>
        <param name="expected_hash" type="text" label="Expected ISCC hash"
               help="The 55-character ISCC hash to verify against">
            <validator type="length" min="55" max="55" message="ISCC hash must be exactly 55 characters"/>
        </param>
    </inputs>
    
    <outputs>
        <data name="output_file" format="txt" label="${tool.name} on ${on_string}"/>
    </outputs>
    
    <tests>
        <!-- Test 1: Successful verification -->
        <test expect_num_outputs="1">
            <param name="input_file" value="test1.png"/>
            <param name="expected_hash" value="K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
            <output name="output_file">
                <assert_contents>
                    <has_text text="OK - Hashes match"/>
                    <has_text text="Expected:  K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <has_text text="Generated: K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
        </test>
        
        <!-- Test 2: Failed verification -->
        <test expect_num_outputs="1">
            <param name="input_file" value="test1.png"/>
            <param name="expected_hash" value="K4AGSPOSB5SS2X427WZ27QASTSBVTS55DXLMFDF7WOJKEOSTDEI3OXQ"/>
            <output name="output_file">
                <assert_contents>
                    <has_text text="FAILED - Hashes do not match"/>
                    <has_text text="Expected:  K4AGSPOSB5SS2X427WZ27QASTSBVTS55DXLMFDF7WOJKEOSTDEI3OXQ"/>
                    <has_text text="Generated: K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
                    <has_n_lines n="4"/>

                </assert_contents>
            </output>
        </test>
        
        <!-- Test 3: FASTA file verification -->
        <test expect_num_outputs="1">
            <param name="input_file" value="test3.fasta"/>
            <param name="expected_hash" value="K4AKF7PTZ7JTAAYZ7YZHZPR5RETKYXXE7RTBTJA4JX5GQQMSLZRC6QQ"/>
            <output name="output_file">
                <assert_contents>
                    <has_text text="OK - Hashes match"/>
                    <has_text text="Expected:  K4AKF7PTZ7JTAAYZ7YZHZPR5RETKYXXE7RTBTJA4JX5GQQMSLZRC6QQ"/>
                    <has_text text="Generated: K4AKF7PTZ7JTAAYZ7YZHZPR5RETKYXXE7RTBTJA4JX5GQQMSLZRC6QQ"/>
                    <has_n_lines n="4"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
What it does
============

Verifies that a file matches an expected ISCC hash for exact checksum verification.

Exit Codes
==========

The tool uses exit codes for workflow logic:

- **0**: Verification successful (OK - hashes match)
- **1**: Verification failed (FAILED - hashes do not match)

Dataset Mapping
===============

When you provide a collection, Galaxy automatically runs verification once per file. All files are verified against the same expected hash.

Output
======

A verification report containing:

- Filename (or element identifier)
- Expected ISCC hash  
- Generated ISCC hash
- Status: OK or FAILED

Example output::

    File: sample1.png
    Expected:  K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY
    Generated: K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY
    
    Status: OK - Hashes match

Use Cases
=========

- Verify file integrity after transfer or storage
- Confirm downloaded files match reference checksums
- Validate that backups are identical to originals
- Quality control for data archiving

Workflow Examples
=================

Verify a single file
--------------------

::

    Input: document.pdf
    Expected hash: K4AOMG...
    ↓
    [Verify ISCC hash]
    ↓
    Output: "OK" or "FAILED"

Verify against reference table
-------------------------------

Generate reference hashes first::

    Original files → [Generate ISCC] → Reference hashes
    
Later verify::

    New files → [Generate ISCC] → New hashes
    ↓
    [Join two Datasets] on filename
    ↓
    Compare hash columns
    ↓
    Result: Which files match/differ

Working with Hash Files in Workflows
=====================================

If you have the expected hash in a file (e.g., from Generate ISCC tool):

1. In the workflow editor, connect the hash file to this tool
2. The hash file content will be used automatically
3. Or manually copy the hash from the file into the text field

Important Notes
===============

- **Exact match only**: Any change to the file will cause verification to fail
- **Bit-level comparison**: Even metadata changes are detected
- **For similarity detection**: Use "Find similar ISCC hashes" tool instead

More Information
================

For details about ISCC: https://sum.iscc.codes/
    ]]></help>
    <expand macro="citations" />
</tool>