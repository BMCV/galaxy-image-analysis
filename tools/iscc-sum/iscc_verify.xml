<tool id="iscc_sum_verify" name="Verify ISCC hash" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="24.1">
    <description>with ISCC-SUM</description>
    <macros>
        <import>macros.xml</import>
        <import>creators.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="version_command" />
    <creator>
        <expand macro="creators/iscc" />
        <expand macro="creators/lco" />
        <expand macro="creators/maartenpaul" />
        <expand macro="creators/etzm" />
    </creator>
        
    <command detect_errors="exit_code"><![CDATA[
        GENERATED=\$(iscc-sum '$input_file' | cut -d':' -f2 | cut -d' ' -f1) &&
        #if $expected_code_source.source_type == "text":
            EXPECTED='$expected_code_source.expected_code_text'
        #else:
            ## Read file and remove all whitespace including newlines
            EXPECTED=\$(cat '$expected_code_source.expected_code_file' | head -n 1 | tr -d '[:space:]')
        #end if
        &&
        echo "File: $input_file.element_identifier" > '${output_file}' &&
        echo "Expected: \$EXPECTED" >> '${output_file}' &&
        echo "Generated: \$GENERATED" >> '${output_file}' &&
        if [ "\$GENERATED" = "\$EXPECTED" ]; then
            echo "Status: OK" >> '${output_file}';
        else
            echo "Status: FAILED" >> '${output_file}';
        fi
    ]]></command>
    
    <inputs>
        <param name="input_file" type="data" format="data" label="File to verify"/>
        <conditional name="expected_code_source">
            <param name="source_type" type="select" label="Source of expected ISCC hash">
                <option value="text">Enter manually</option>
                <option value="file">From file (workflow input)</option>
            </param>
            <when value="text">
                <param name="expected_code_text" type="text" label="Expected ISCC" 
                       help="The 55-character ISCC-SUM hash to verify against">
                    <validator type="length" min="55" max="55" message="ISCC must be exactly 55 characters"/>
                </param>
            </when>
            <when value="file">
                <param name="expected_code_file" type="data" format="txt" label="File containing expected ISCC"
                       help="Text file containing the ISCC from a previous step"/>
            </when>
        </conditional>
    </inputs>
    
    <outputs>
        <data name="output_file" format="txt" label="${tool.name} on ${on_string}"/>
    </outputs>
    
    <tests>
        <!-- Test verification with text input - match -->
        <test expect_num_outputs="1">
            <param name="input_file" value="test1.png"/>
            <conditional name="expected_code_source">
                <param name="source_type" value="text"/>
                <param name="expected_code_text" value="K4AOMGOGQJA4Y46PAC4YPPA63GKD5RVFPR7FU3I4OOEW44TYXNYOTMY"/>
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <has_text text="Status: OK"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test verification with text input - mismatch -->
        <test expect_num_outputs="1">
            <param name="input_file" value="test1.png"/>
            <conditional name="expected_code_source">
                <param name="source_type" value="text"/>
                <param name="expected_code_text" value="K4AGSPOSB5SS2X427WZ27QASTSBVTS55DXLMFDF7WOJKEOSTDEI3OXQ"/>
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <has_text text="Status: FAILED"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test verification with file input -->
        <test expect_num_outputs="1">
            <param name="input_file" value="test1.png"/>
            <conditional name="expected_code_source">
                <param name="source_type" value="file"/>
                <param name="expected_code_file" value="test1_iscc.txt"/>
            </conditional>
            <output name="output_file">
                <assert_contents>
                    <has_text text="Status: OK"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

Verifies that a file matches an expected ISCC hash for checksum verification.

This tool generates an ISCC for the input file and compares it against 
the provided expected code. It reports whether the codes match (OK) or don't match (FAILED).

**Use Cases**

- Verify file integrity after transfer or storage
- Confirm you have the correct version of a file
- Validate that a file hasn't been modified
- Workflow verification: Generate ISCC in one step, verify in another

**Input**

- A file to verify
- The expected ISCC-SUM code, either:
  - Entered manually as text (55-character string)
  - From a file output from a previous workflow step

**Output**

A verification report showing:

- The filename
- Expected ISCC hash
- Generated ISCC from the file
- Status: OK (hashes match) or FAILED (hashes don't match)

**Workflow Usage**

In a workflow, you can:

1. Use "Generate ISCC hash" tool to create an ISCC hash for a reference file
2. Connect that output to this tool's "expected hash file" input
3. Provide a test file to verify

This allows automated verification within Galaxy workflows.

**More Information**

For more details about ISCC, visit: https://iscc.codes/
    ]]></help>
    <expand macro="citations" />
</tool>